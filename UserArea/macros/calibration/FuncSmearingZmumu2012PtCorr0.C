#include <SmearingTool.h>

// couldn't be inside class due to root feacher during TF1 creation:
Double_t DoubleGauss(Double_t*, Double_t* );

   const float SmearingTool::PTbin[14]={25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 80, 100, 150, 300};
   const float SmearingTool::ETAbin[9]={-2.1, -1.6, -1.2, -0.8, 0, 0.8, 1.2, 1.6, 2.1};

   ////// Smearing parametrization for single muon:
   const float SmearingTool::mean[104]={
                   6.92255e-05, -0.000971291, -0.0011029, -0.00108265, -0.00107524, -0.00120185, -0.00162482, -0.00170297, -0.001866, -0.00207858, -0.00178558, -0.00284272, -0.00583372, 
                   0.0003302, -0.000608273, -0.000531002, -0.000545614, -0.00049052, -0.000748074, -0.000431515, -0.000621831, -0.00082172, -0.00049626, -0.000454447, -0.00080472, -0.00379088, 
                   0.000595436, -6.85276e-05, -3.81977e-05, -7.11406e-05, -9.2611e-05, -0.000156773, -0.000104559, -0.000347452, -0.00014549, -0.000193503, -0.000221181, -0.000434196, -0.000759722, 
                   0.000296027, 0.00012812, 0.000121809, 9.54221e-05, 0.000103291, 3.19817e-05, 0.000127942, 6.76706e-05, 0.000154664, 6.39748e-05, 0.000132824, 0.000124915, -0.000984903, 
                   0.000347581, 0.000113915, 0.000110841, 9.86713e-05, 7.92619e-05, 3.51527e-05, 5.12868e-05, 7.12359e-05, -9.36246e-05, 0.000112778, 4.47641e-05, -0.000302805, -4.17574e-05, 
                   0.000538608, -3.0022e-05, -7.79518e-05, -0.000102278, -0.000164536, -0.000136165, -0.000209363, -0.000369946, -0.000331892, -0.000459408, -0.000143269, -0.00055453, -0.000228959, 
                   0.000274457, -0.000532305, -0.000573496, -0.000524993, -0.000610515, -0.000635942, -0.00064926, -0.000922983, -0.000617012, -0.000455953, -0.000226766, -0.000575084, -0.00033188, 
                   -4.98823e-05, -0.000958548, -0.00108406, -0.00104873, -0.00116264, -0.00115211, -0.00157486, -0.00168266, -0.00125463, -0.00123174, -0.00149736, -0.0023454, -0.00277508};
   const float SmearingTool::sig1[104]={
                   0.0177388, 0.0191759, 0.0195416, 0.0200628, 0.0204526, 0.0209436, 0.0207195, 0.0226579, 0.0223682, 0.0288496, 0.0314611, 0.0368222, 0.0552507, 
                   0.0170957, 0.0178989, 0.0182134, 0.0187132, 0.019059, 0.0195434, 0.0198972, 0.0207375, 0.0206465, 0.0242057, 0.0255979, 0.0292947, 0.0364989, 
                   0.0141821, 0.0147521, 0.0151124, 0.0154828, 0.0160099, 0.0162166, 0.0168925, 0.0170781, 0.0181725, 0.0185387, 0.0200963, 0.0245433, 0.0352209, 
                   0.00993344, 0.010358, 0.0107861, 0.0112245, 0.0116338, 0.0119897, 0.0125869, 0.0128158, 0.013436, 0.0139209, 0.0156882, 0.0183742, 0.0307973, 
                   0.0099306, 0.0103342, 0.0107477, 0.0112109, 0.0115909, 0.0120685, 0.0124442, 0.0130171, 0.0133458, 0.0141869, 0.0155106, 0.0183835, 0.0310225, 
                   0.014187, 0.0149112, 0.015174, 0.0156733, 0.015963, 0.0164822, 0.0165942, 0.0175856, 0.0181091, 0.0191492, 0.0205383, 0.023792, 0.035763, 
                   0.0169024, 0.0176308, 0.0179035, 0.0186486, 0.0189289, 0.0194992, 0.0198735, 0.0201993, 0.0199709, 0.0243392, 0.0251774, 0.0286054, 0.0360809, 
                   0.0180434, 0.0190998, 0.0192779, 0.0200406, 0.0201822, 0.0210545, 0.0212127, 0.0207516, 0.0226374, 0.0287996, 0.0317416, 0.0365573, 0.0502419};
   const float SmearingTool::sig2[104]={
                   0.0291768, 0.0323039, 0.032196, 0.0332284, 0.0332599, 0.0338578, 0.0332543, 0.0378582, 0.0351585, 3, 3, 3, 3, 
                   0.0312723, 0.0335092, 0.0347194, 0.0354874, 0.0363984, 0.0392191, 0.0379233, 0.0428572, 0.0402112, 3, 3, 3, 3, 
                   0.027831, 0.0290042, 0.0303612, 0.0304343, 0.0314397, 0.0320847, 0.033939, 0.0327599, 0.0366983, 0.0367362, 0.0373802, 0.0551092, 3, 
                   0.0238626, 0.0258809, 0.0271666, 0.0288283, 0.0303291, 0.0307706, 0.0327814, 0.0322095, 0.034405, 0.0346639, 0.0411142, 0.0402162, 3, 
                   0.0237517, 0.0249604, 0.0260948, 0.0277902, 0.0287154, 0.0305243, 0.0309471, 0.0328011, 0.0325406, 0.0371994, 0.0366085, 0.0416909, 3, 
                   0.0274324, 0.0299522, 0.0299757, 0.0314266, 0.0314926, 0.0322366, 0.031594, 0.0344703, 0.0362968, 0.0412686, 0.0390516, 0.041224, 3, 
                   0.0309736, 0.0319558, 0.0336259, 0.0360113, 0.0361161, 0.0388225, 0.0398584, 0.0387849, 0.0353558, 3, 3, 3, 3, 
                   0.030609, 0.0328333, 0.0320772, 0.0339295, 0.0333744, 0.0346026, 0.0343461, 0.0353922, 0.0376863, 3, 3, 3, 3};
   const float SmearingTool::Asig2[104]={
                   0.193918, 0.145261, 0.18077, 0.182536, 0.208435, 0.244001, 0.39328, 0.191826, 0.4, 0, 0, 0, 0, 
                   0.0767931, 0.0729819, 0.0688664, 0.0678578, 0.068866, 0.0561788, 0.0709813, 0.0428686, 0.068098, 0, 0, 0, 0, 
                   0.0655414, 0.0697774, 0.0699088, 0.0808423, 0.0788703, 0.0891442, 0.0755227, 0.105177, 0.0651224, 0.0961493, 0.144507, 0.0734995, 0, 
                   0.0396221, 0.0373958, 0.0381934, 0.0362512, 0.0360468, 0.0411664, 0.0379485, 0.0456967, 0.0425643, 0.0534213, 0.0434821, 0.0862463, 0, 
                   0.0390712, 0.0421013, 0.0434166, 0.0403798, 0.0424656, 0.040323, 0.0453802, 0.0429115, 0.0500646, 0.0420002, 0.0624359, 0.0851237, 0, 
                   0.0759769, 0.0632716, 0.0779514, 0.0741283, 0.0855802, 0.0872496, 0.119021, 0.09782, 0.084777, 0.0680016, 0.101697, 0.182151, 0, 
                   0.0796962, 0.0880755, 0.0815587, 0.0627519, 0.0688941, 0.0570858, 0.0600376, 0.0734518, 0.130418, 0, 0, 0, 0, 
                   0.144214, 0.140096, 0.204276, 0.17543, 0.228737, 0.221697, 0.310113, 0.4, 0.310996, 0, 0, 0, 0};

   const float SmearingTool::ERRmean[104]={
                   5.92758e-05, 5.03386e-05, 4.51582e-05, 4.15172e-05, 5.15868e-05, 8.88091e-05, 0.000138116, 0.000195476, 0.000267601, 0.000276979, 0.000385351, 0.000692309, 0.00278808, 
                   5.71528e-05, 4.76322e-05, 4.07691e-05, 3.51583e-05, 4.28958e-05, 7.15528e-05, 0.000110258, 0.000152339, 0.000203189, 0.000209478, 0.000280578, 0.000471897, 0.0012527, 
                   4.58525e-05, 3.75454e-05, 3.116e-05, 2.71706e-05, 3.44061e-05, 5.76288e-05, 8.74468e-05, 0.000123015, 0.000164494, 0.000171399, 0.000237926, 0.00041239, 0.00106398, 
                   2.07567e-05, 1.6016e-05, 1.37359e-05, 1.29689e-05, 1.67964e-05, 2.82337e-05, 4.31633e-05, 6.04548e-05, 8.19248e-05, 8.46441e-05, 0.000117307, 0.000202752, 0.000582826, 
                   2.08376e-05, 1.6064e-05, 1.37671e-05, 1.30336e-05, 1.68902e-05, 2.83658e-05, 4.32396e-05, 6.12351e-05, 8.2211e-05, 8.52542e-05, 0.000119116, 0.000206897, 0.000587872, 
                   4.63931e-05, 3.7808e-05, 3.1483e-05, 2.74944e-05, 3.47645e-05, 5.84186e-05, 8.85592e-05, 0.000126521, 0.000167533, 0.0001726, 0.000237646, 0.000408352, 0.00107169, 
                   5.68841e-05, 4.76434e-05, 4.07851e-05, 3.52211e-05, 4.27995e-05, 7.2207e-05, 0.000109466, 0.000154387, 0.000203488, 0.00021361, 0.000277999, 0.000461313, 0.00124217, 
                   5.83264e-05, 4.98943e-05, 4.47746e-05, 4.11772e-05, 5.1196e-05, 8.78562e-05, 0.000136542, 0.000196673, 0.000267288, 0.00027387, 0.000386457, 0.000686844, 0.00245861};
   const float SmearingTool::ERRsig1[104]={
                   0.000176885, 0.000135623, 0.000137296, 0.000129036, 0.000172286, 0.000325849, 0.000569089, 0.000661219, 0.000536856, 0.000199708, 0.00028342, 0.000542646, 0.0029407, 
                   0.000109093, 8.94904e-05, 7.41316e-05, 6.49549e-05, 7.94649e-05, 0.000126113, 0.000206755, 0.000254659, 0.000381367, 0.000148508, 0.000199476, 0.000341129, 0.000977714, 
                   7.56941e-05, 6.36569e-05, 5.16681e-05, 4.73506e-05, 6.06358e-05, 0.000101692, 0.000150781, 0.000244271, 0.000294729, 0.000352187, 0.000574509, 0.000940754, 0.000815792, 
                   2.62747e-05, 1.93972e-05, 1.66077e-05, 1.54053e-05, 1.96907e-05, 3.40958e-05, 5.10912e-05, 7.5393e-05, 9.88345e-05, 0.0001105, 0.000151925, 0.000340284, 0.000426098, 
                   2.62353e-05, 2.04463e-05, 1.71663e-05, 1.5996e-05, 2.08607e-05, 3.42321e-05, 5.42545e-05, 7.62223e-05, 0.000109607, 0.000104994, 0.000173825, 0.00033899, 0.000430583, 
                   8.29776e-05, 6.01324e-05, 5.33615e-05, 4.66451e-05, 6.163e-05, 0.000106314, 0.00018182, 0.0002643, 0.000292096, 0.000277624, 0.000506723, 0.00127996, 0.000827549, 
                   0.000107887, 9.44274e-05, 7.78596e-05, 6.34176e-05, 7.95703e-05, 0.000127903, 0.000189935, 0.000312258, 0.000527643, 0.000151471, 0.000197441, 0.000332051, 0.000963302, 
                   0.000155304, 0.000130204, 0.00013818, 0.000122432, 0.000174319, 0.000315368, 0.000561959, 0.000303971, 0.00116454, 0.000197372, 0.000284957, 0.000536312, 0.00239827};
   const float SmearingTool::ERRsig2[104]={
                   0.000508718, 0.000541312, 0.000458454, 0.000439188, 0.000531273, 0.000892963, 0.00101218, 0.00258476, 0.000736887, 0, 0, 0, 0, 
                   0.000688597, 0.000620222, 0.000560447, 0.000512434, 0.00063977, 0.00129933, 0.00174422, 0.00382847, 0.00364055, 0, 0, 0, 0, 
                   0.000483876, 0.000392696, 0.000324725, 0.000268717, 0.000359728, 0.000560624, 0.00099458, 0.00120146, 0.00239295, 0.0020781, 0.00261374, 0.0149399, 0, 
                   0.000226017, 0.000175683, 0.00014973, 0.000146975, 0.000193537, 0.000307296, 0.000512463, 0.000650583, 0.000959502, 0.000907594, 0.00179652, 0.00245748, 0, 
                   0.000228416, 0.00016858, 0.000140589, 0.000139807, 0.000177961, 0.000312554, 0.000457198, 0.00069788, 0.000882098, 0.00110684, 0.00135234, 0.00262536, 0, 
                   0.000465789, 0.000407198, 0.000309667, 0.000288492, 0.000342845, 0.00059382, 0.000778098, 0.0014099, 0.00192856, 0.00261583, 0.00328981, 0.00600294, 0, 
                   0.000654832, 0.000547393, 0.000494559, 0.000537518, 0.000632114, 0.00128343, 0.00193159, 0.00261403, 0.00245442, 0, 0, 0, 0, 
                   0.000582734, 0.000537332, 0.000409514, 0.000436039, 0.000487159, 0.000947036, 0.00125747, 0.000321646, 0.00286793, 0, 0, 0, 0};
   const float SmearingTool::ERRAsig2[104]={
                   0.023281, 0.0150653, 0.016899, 0.015511, 0.0223367, 0.0439823, 0.3364, 0.0750119, 0.37364, 0, 0, 0, 0, 
                   0.009089, 0.00682006, 0.00535805, 0.00469598, 0.00565248, 0.00777575, 0.0147816, 0.0142942, 0.0258965, 0, 0, 0, 0, 
                   0.00575329, 0.0047296, 0.00358943, 0.00352169, 0.00441128, 0.00745886, 0.0101285, 0.0192635, 0.0185426, 0.024576, 0.0491999, 0.0536635, 0, 
                   0.00152659, 0.000984225, 0.000804782, 0.000687201, 0.0008315, 0.0014978, 0.00208639, 0.00337148, 0.00412394, 0.00499104, 0.00583058, 0.0195462, 0, 
                   0.0015332, 0.00114514, 0.000926311, 0.00078447, 0.00100864, 0.00152719, 0.00251163, 0.00331333, 0.00512329, 0.00409726, 0.00847475, 0.0186132, 0, 
                   0.00671925, 0.0041283, 0.0039507, 0.00323743, 0.00452388, 0.00783163, 0.0151308, 0.0191746, 0.0197363, 0.0157593, 0.038435, 0.125701, 0, 
                   0.00905551, 0.00814199, 0.00602386, 0.00434996, 0.00567454, 0.00802676, 0.0119107, 0.0220567, 0.0489339, 0, 0, 0, 0, 
                   0.0172761, 0.0136242, 0.0171169, 0.0137797, 0.0221123, 0.0395548, 0.0778073, 0.0837573, 0.131932, 0, 0, 0, 0};

   const float SmearingTool::ResRMS[104]={
                   0.0210252, 0.0222618, 0.0229496, 0.0236158, 0.0241682, 0.0250542, 0.0260522, 0.0266811, 0.0276247, 0.0287379, 0.0311999, 0.0358001, 0.0460679, 
                   0.0193413, 0.0203062, 0.0206666, 0.0211374, 0.0215897, 0.0220207, 0.0225298, 0.0228837, 0.0233832, 0.0241872, 0.0255785, 0.0291778, 0.0354947, 
                   0.0162945, 0.017076, 0.017658, 0.0182125, 0.0187553, 0.0193422, 0.0198572, 0.0204406, 0.0209423, 0.0221594, 0.0243818, 0.0283692, 0.0344815, 
                   0.0117885, 0.0124387, 0.0130438, 0.0136022, 0.0141865, 0.0147862, 0.0154244, 0.0158522, 0.0165687, 0.0174949, 0.0193388, 0.0227088, 0.0305626, 
                   0.01174, 0.0124049, 0.0129916, 0.0135508, 0.0141062, 0.0147206, 0.0153064, 0.0159591, 0.0164582, 0.0175827, 0.0192714, 0.0230384, 0.0307916, 
                   0.016459, 0.0172271, 0.017821, 0.0184107, 0.0189264, 0.0194864, 0.0201298, 0.0210477, 0.0214746, 0.0226302, 0.0240678, 0.0281555, 0.0349817, 
                   0.0192183, 0.0201268, 0.0205685, 0.0210414, 0.0214438, 0.0219575, 0.0225097, 0.022977, 0.0233997, 0.0243226, 0.025159, 0.0285203, 0.035189, 
                   0.0210412, 0.0223047, 0.0230774, 0.0237544, 0.0243305, 0.0251402, 0.0260615, 0.0272217, 0.0280872, 0.0286924, 0.0314587, 0.0355779, 0.0440838};
   const float SmearingTool::ErrResRMS[104]={
                   4.27261e-05, 3.62719e-05, 3.2461e-05, 2.9801e-05, 3.69279e-05, 6.34258e-05, 9.844e-05, 0.000138802, 0.00018875, 0.000194414, 0.00026799, 0.000462486, 0.00136084, 
                   4.14054e-05, 3.46053e-05, 2.96425e-05, 2.54916e-05, 3.11152e-05, 5.19195e-05, 7.97885e-05, 0.00010987, 0.000146662, 0.000147962, 0.000198098, 0.00033101, 0.000838016, 
                   3.36998e-05, 2.76506e-05, 2.30592e-05, 2.00811e-05, 2.53868e-05, 4.27269e-05, 6.46542e-05, 9.07566e-05, 0.000120641, 0.000126241, 0.000173309, 0.000292481, 0.000721503, 
                   1.58402e-05, 1.23596e-05, 1.0647e-05, 1.00887e-05, 1.3131e-05, 2.21326e-05, 3.37858e-05, 4.7261e-05, 6.40956e-05, 6.6357e-05, 9.12449e-05, 0.000152549, 0.000406239, 
                   1.58681e-05, 1.23332e-05, 1.06145e-05, 1.00759e-05, 1.3096e-05, 2.20771e-05, 3.36714e-05, 4.76875e-05, 6.38154e-05, 6.68607e-05, 9.1731e-05, 0.000156785, 0.000409646, 
                   3.41162e-05, 2.7897e-05, 2.32854e-05, 2.03573e-05, 2.57352e-05, 4.31126e-05, 6.54879e-05, 9.3467e-05, 0.000123634, 0.000127649, 0.00017238, 0.000289204, 0.000724398, 
                   4.13254e-05, 3.45499e-05, 2.97061e-05, 2.55815e-05, 3.10461e-05, 5.2393e-05, 7.95321e-05, 0.000111694, 0.000146679, 0.000150889, 0.000196315, 0.00032422, 0.00083594, 
                   4.20859e-05, 3.6035e-05, 3.22826e-05, 2.96491e-05, 3.67896e-05, 6.28124e-05, 9.73557e-05, 0.000140655, 0.000189072, 0.000192285, 0.000268417, 0.000459999, 0.00133649};

   ////// End smearing parametrization for single muon:

SmearingTool::SmearingTool(){
}
float SmearingTool::PTsmear(float PTmuonGen, float ETAmuonGen, float CHARGEmuonGen, float PTmuonReco, int Ismear, TString ParVar,float ParSig){
   //Ismear = 1 - Smear with RND (no RECO use), Ismear = 2 - Smear with SF for RECO and GEN
   if(Ismear != 1 && Ismear != 2)std::cout << "ERROR SmearingTool::PTsmear: set Ismear to 1 or 2 for smearing" << std::endl;
   const int NPThist = (sizeof(PTbin)/sizeof(float)-1);
   const int NETAhist = (sizeof(ETAbin)/sizeof(float)-1);
   //const int Nhist = NPThist*NETAhist;
   ////// Make smearing for single muon from Gen level PostFSR:
   float PTmuonSmear = -10.;
   float meanVar = 0;
   float sigVar = 0;//for sig1 and sig2
   float Asig2Var = 0;
   if(ParVar == "mean")meanVar = ParSig;
   if(ParVar == "sig1" || ParVar == "sig2")sigVar = ParSig;
   if(ParVar == "Asig2Var")Asig2Var = ParSig;
   int iK_cand = -1;
   for(int iPT = 0; iPT < NPThist; iPT++){
   for(int iETA = 0; iETA < NETAhist; iETA++){
      int iK = iPT + iETA*NPThist;
      // smear muons which out of range PT and ETA
      float PTcutDown = PTbin[iPT];
      float PTcutUp = PTbin[iPT+1];
      if(iPT == 0 && PTmuonGen < PTbin[0])PTcutDown = PTmuonGen-0.001;
      if(iPT == (NPThist-1) && PTmuonGen > PTbin[NPThist])PTcutUp = PTmuonGen+0.001;
      float ETAcutDown = ETAbin[iETA];
      float ETAcutUp = ETAbin[iETA+1];
      if(iETA == 0 && ETAmuonGen < ETAbin[0])ETAcutDown = ETAmuonGen-0.001;
      if(iETA == (NETAhist-1) && ETAmuonGen >= ETAbin[NETAhist])ETAcutUp = ETAmuonGen+0.001;
      if(PTmuonGen >= PTcutDown && PTmuonGen < PTcutUp
      && ETAmuonGen >= ETAcutDown && ETAmuonGen < ETAcutUp) iK_cand = iK;
   }}

   ///// Set Scale Factor
   float ScaleFactor = 1.;
   if (fabs(ETAmuonGen) < 0.8) ScaleFactor = 1.21;
   if (fabs(ETAmuonGen) >= 0.8 && fabs(ETAmuonGen) < 1.2) ScaleFactor = 1.16;
   if (fabs(ETAmuonGen) >= 1.2) ScaleFactor = 1.11;
   TF1* fitDoubleGauss = new TF1("fitDoubleGauss", DoubleGauss, -0.1, 0.1, 5);
   fitDoubleGauss->SetParameter(4,1.);
   if(iK_cand > -1 && Ismear == 1){
      float meanCorr = mean[iK_cand] + meanVar*ERRmean[iK_cand];
      float sig1Corr = sig1[iK_cand] + sigVar*ERRsig1[iK_cand];
      if(sig1Corr < 0.005) sig1Corr = 0.005;
      float sig2Corr = sig2[iK_cand] + sigVar*ERRsig2[iK_cand];
      if(sig2Corr < 0.005) sig2Corr = 0.005;
      float Asig2Corr = Asig2[iK_cand] + Asig2Var*ERRAsig2[iK_cand];
      if(Asig2Corr < 0.) Asig2Corr = 0.;
      fitDoubleGauss->SetParameter(0,meanCorr);
      fitDoubleGauss->SetParameter(1,ScaleFactor*sig1Corr);
      fitDoubleGauss->SetParameter(2,Asig2Corr);
      fitDoubleGauss->SetParameter(3,ScaleFactor*sig2Corr);
      Double_t resSim = fitDoubleGauss->GetRandom();
      PTmuonSmear = PTmuonGen*(1+resSim);
   }
   delete fitDoubleGauss;
   if(iK_cand > -1 && Ismear == 2){
      PTmuonSmear = PTmuonGen + ScaleFactor*(PTmuonReco - PTmuonGen);
   }
   ////// End Smearing parametrization for single muon:

   return PTmuonSmear;
 }//end PTsmear function

   Double_t DoubleGauss(Double_t *x, Double_t *par)
   {
       double dgauss = 0.;
        if(par[1] < par[3]){//not normalized gauss both gauss are  = 1 at x[0]=par[0]
                  dgauss =  exp(-0.5*(x[0]-par[0])*(x[0]-par[0])/par[1]/par[1]);
                  dgauss = dgauss + par[2]*exp(-0.5*(x[0]-par[0])*(x[0]-par[0])/par[3]/par[3]);
                  dgauss = par[4]*dgauss;
        }
       return dgauss;
   }
